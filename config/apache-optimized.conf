# Optimized Apache Configuration for Angular SSR
# Save this as: /etc/apache2/sites-available/findmeroom-le-ssl.conf

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName findmeroom.com
    ServerAlias www.findmeroom.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/findmeroom.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/findmeroom.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Enable HTTP/2 for better performance
    Protocols h2 http/1.1

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Document Root (for error pages, etc.)
    DocumentRoot /var/www/findmeroom/dist/sheltos_front/browser

    # Performance Optimizations
    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # Static Files - Serve directly from Apache (FAST)
    <Directory "/var/www/findmeroom/dist/sheltos_front/browser">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Aggressive caching for static assets
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
            Header append Cache-Control "public, immutable"
        </FilesMatch>

        # Enable ETags and Last-Modified
        FileETag MTime Size

        # Enable gzip compression
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
        </IfModule>
    </Directory>

    # Proxy SSR requests to Node.js (OPTIMIZED)
    ProxyPass /api http://127.0.0.1:4000/api
    ProxyPassReverse /api http://127.0.0.1:4000/api

    # Main SSR proxy with performance optimizations
    ProxyPass / http://127.0.0.1:4000/
    ProxyPassReverse / http://127.0.0.1:4000/

    # Proxy Configuration Optimizations
    <Proxy http://127.0.0.1:4000/*>
        # Connection pooling
        ProxySet connectiontimeout=5
        ProxySet timeout=30
        ProxySet retry=1

        # Keep connections alive
        SetEnv proxy-nokeepalive 0
        SetEnv proxy-initial-not-pooled 1
    </Proxy>

    # Request Header Forwarding (Critical for SSR)
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Error and Access Logs
    ErrorLog ${APACHE_LOG_DIR}/findmeroom_error.log
    CustomLog ${APACHE_LOG_DIR}/findmeroom_access.log combined

    # Performance Tuning
    KeepAlive On
    KeepAliveTimeout 5
    MaxKeepAliveRequests 100

    # Process limits
    StartServers 2
    MinSpareServers 2
    MaxSpareServers 5
    MaxRequestWorkers 150
    MaxConnectionsPerChild 1000

</VirtualHost>
</IfModule>

# HTTP to HTTPS Redirect
<VirtualHost *:80>
    ServerName findmeroom.com
    ServerAlias www.findmeroom.com

    # Redirect all HTTP to HTTPS
    Redirect permanent / https://findmeroom.com/
</VirtualHost>
